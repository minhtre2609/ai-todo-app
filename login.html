<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ÄÄƒng nháº­p vÃ o AI Smart To-Do List">
    <title>ÄÄƒng Nháº­p - AI Smart To-Do List</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="login-container">
        <div class="login-card glass-card">
            <div class="login-header">
                <h1>ğŸ¤– AI Smart To-Do List</h1>
                <p>Quáº£n lÃ½ cÃ´ng viá»‡c thÃ´ng minh vá»›i AI</p>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <h2>ÄÄƒng Nháº­p</h2>
                <form id="loginFormElement">
                    <div class="input-wrapper">
                        <label for="loginUsername">TÃªn Ä‘Äƒng nháº­p</label>
                        <input type="text" id="loginUsername" class="task-input" placeholder="Nháº­p tÃªn Ä‘Äƒng nháº­p"
                            required autocomplete="username">
                    </div>

                    <div class="input-wrapper" style="position: relative;">
                        <label for="loginPassword">Máº­t kháº©u</label>
                        <input type="password" id="loginPassword" class="task-input" placeholder="Nháº­p máº­t kháº©u"
                            required autocomplete="current-password" style="padding-right: 45px;">
                        <span onclick="togglePassword('loginPassword', this)" style="position: absolute; right: 12px; top: 38px; cursor: pointer; 
                                   font-size: 1.2rem; user-select: none;">
                            ğŸ‘ï¸
                        </span>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">
                        ğŸ”“ ÄÄƒng Nháº­p
                    </button>
                </form>

                <div class="auth-switch">
                    <p>ChÆ°a cÃ³ tÃ i khoáº£n? <a href="#" id="showRegister">ÄÄƒng kÃ½ ngay</a></p>
                    <p style="margin-top: 8px;">
                        <a href="#" id="showForgotPassword" style="color: var(--accent-secondary); font-size: 0.9rem;">
                            ğŸ”‘ QuÃªn máº­t kháº©u?
                        </a>
                    </p>
                </div>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="auth-form hidden">
                <h2>ÄÄƒng KÃ½ TÃ i Khoáº£n</h2>
                <form id="registerFormElement">
                    <div class="input-wrapper">
                        <label for="registerFullName">Há» vÃ  tÃªn</label>
                        <input type="text" id="registerFullName" class="task-input" placeholder="Nháº­p há» vÃ  tÃªn"
                            required>
                    </div>

                    <div class="input-wrapper">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" class="task-input"
                            placeholder="Nháº­p email cá»§a báº¡n (Ä‘á»ƒ reset máº­t kháº©u)" required autocomplete="email">
                        <small style="color: var(--text-secondary); font-size: 0.85rem;">
                            Email dÃ¹ng Ä‘á»ƒ reset máº­t kháº©u khi quÃªn
                        </small>
                    </div>

                    <div class="input-wrapper">
                        <label for="registerUsername">TÃªn Ä‘Äƒng nháº­p</label>
                        <input type="text" id="registerUsername" class="task-input"
                            placeholder="TÃªn Ä‘Äƒng nháº­p (3-20 kÃ½ tá»±)" required autocomplete="username"
                            pattern="[a-zA-Z0-9_]{3,20}">
                        <small style="color: var(--text-secondary); font-size: 0.85rem;">
                            Chá»‰ chá»©a chá»¯, sá»‘ vÃ  dáº¥u gáº¡ch dÆ°á»›i (_)
                        </small>
                    </div>

                    <div class="input-wrapper" style="position: relative;">
                        <label for="registerPassword">Máº­t kháº©u</label>
                        <input type="password" id="registerPassword" class="task-input"
                            placeholder="Máº­t kháº©u (tá»‘i thiá»ƒu 6 kÃ½ tá»±)" required autocomplete="new-password"
                            minlength="6" style="padding-right: 45px;">
                        <span onclick="togglePassword('registerPassword', this)" style="position: absolute; right: 12px; top: 38px; cursor: pointer; 
                                   font-size: 1.2rem; user-select: none;">
                            ğŸ‘ï¸
                        </span>
                    </div>

                    <div class="input-wrapper" style="position: relative;">
                        <label for="registerPasswordConfirm">XÃ¡c nháº­n máº­t kháº©u</label>
                        <input type="password" id="registerPasswordConfirm" class="task-input"
                            placeholder="Nháº­p láº¡i máº­t kháº©u" required autocomplete="new-password"
                            style="padding-right: 45px;">
                        <span onclick="togglePassword('registerPasswordConfirm', this)" style="position: absolute; right: 12px; top: 38px; cursor: pointer; 
                                   font-size: 1.2rem; user-select: none;">
                            ğŸ‘ï¸
                        </span>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">
                        âœ¨ ÄÄƒng KÃ½
                    </button>
                </form>

                <div class="auth-switch">
                    <p>ÄÃ£ cÃ³ tÃ i khoáº£n? <a href="#" id="showLogin">ÄÄƒng nháº­p</a></p>
                </div>
            </div>

            <!-- Forgot Password Form -->
            <div id="forgotPasswordForm" class="auth-form hidden">
                <h2>ğŸ”‘ QuÃªn Máº­t Kháº©u</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9rem;">
                    Nháº­p tÃªn Ä‘Äƒng nháº­p cá»§a báº¡n. ChÃºng tÃ´i sáº½ gá»­i email reset máº­t kháº©u
                    Ä‘áº¿n Ä‘á»‹a chá»‰ email Ä‘Ã£ Ä‘Äƒng kÃ½.
                </p>
                <form id="forgotPasswordFormElement">
                    <div class="input-wrapper">
                        <label for="resetUsername">TÃªn Ä‘Äƒng nháº­p</label>
                        <input type="text" id="resetUsername" class="task-input" placeholder="Nháº­p tÃªn Ä‘Äƒng nháº­p"
                            required>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">
                        ğŸ“§ Gá»­i Email Reset
                    </button>
                </form>

                <div class="auth-switch">
                    <p>Nhá»› máº­t kháº©u rá»“i? <a href="#" id="backToLogin">ÄÄƒng nháº­p</a></p>
                </div>
            </div>

            <!-- Message Display -->
            <div id="authMessage" class="auth-message hidden"></div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import authService from './firebase-auth.js';

        // Password toggle function
        window.togglePassword = function (inputId, icon) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                icon.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                icon.textContent = 'ğŸ‘ï¸';
            }
        };

        // Check if already logged in - DISABLED to prevent redirect loop
        // (async () => {
        //     await authService.waitForAuth();
        //
        //     if (authService.isLoggedIn()) {
        //         const user = authService.getCurrentUser();
        //         if (user && user.role === 'admin') {
        //             window.location.href = 'admin.html';
        //         } else {
        //             window.location.href = 'index.html';
        //         }
        //     }
        // })();

        // Form elements
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');

        // Form switching
        document.getElementById('showRegister').addEventListener('click', (e) => {
            e.preventDefault();
            hideAllForms();
            registerForm.classList.remove('hidden');
            clearMessage();
        });

        document.getElementById('showLogin').addEventListener('click', (e) => {
            e.preventDefault();
            hideAllForms();
            loginForm.classList.remove('hidden');
            clearMessage();
        });

        document.getElementById('showForgotPassword').addEventListener('click', (e) => {
            e.preventDefault();
            hideAllForms();
            forgotPasswordForm.classList.remove('hidden');
            clearMessage();
        });

        document.getElementById('backToLogin').addEventListener('click', (e) => {
            e.preventDefault();
            hideAllForms();
            loginForm.classList.remove('hidden');
            clearMessage();
        });

        function hideAllForms() {
            loginForm.classList.add('hidden');
            registerForm.classList.add('hidden');
            forgotPasswordForm.classList.add('hidden');
        }

        // Login form
        document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            console.log('ğŸ” Attempting login for:', username);
            showMessage('Äang Ä‘Äƒng nháº­p...', 'info');

            const result = await authService.login(username, password);

            if (result.success) {
                showMessage(result.message, 'success');
                setTimeout(() => {
                    if (result.user.role === 'admin') {
                        window.location.href = 'admin.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                }, 500);
            } else {
                showMessage(result.message, 'error');
            }
        });

        // Register form
        document.getElementById('registerFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();

            const fullName = document.getElementById('registerFullName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            if (password !== passwordConfirm) {
                showMessage('Máº­t kháº©u xÃ¡c nháº­n khÃ´ng khá»›p!', 'error');
                return;
            }

            const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
            if (!usernameRegex.test(username)) {
                showMessage('Username pháº£i tá»« 3-20 kÃ½ tá»±, chá»‰ chá»©a chá»¯, sá»‘ vÃ  _', 'error');
                return;
            }

            showMessage('Äang Ä‘Äƒng kÃ½...', 'info');
            const result = await authService.register(username, password, fullName, email);

            if (result.success) {
                showMessage(result.message + ' Äang chuyá»ƒn sang Ä‘Äƒng nháº­p...', 'success');
                setTimeout(() => {
                    document.getElementById('registerFormElement').reset();
                    hideAllForms();
                    loginForm.classList.remove('hidden');
                    document.getElementById('loginUsername').value = username;
                }, 1500);
            } else {
                showMessage(result.message, 'error');
            }
        });

        // Forgot password form
        document.getElementById('forgotPasswordFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('resetUsername').value.trim();

            if (!username) {
                showMessage('Vui lÃ²ng nháº­p tÃªn Ä‘Äƒng nháº­p!', 'error');
                return;
            }

            showMessage('Äang gá»­i email...', 'info');
            const result = await authService.resetPassword(username);

            if (result.success) {
                showMessage(result.message, 'success');
                setTimeout(() => {
                    document.getElementById('forgotPasswordFormElement').reset();
                    hideAllForms();
                    loginForm.classList.remove('hidden');
                }, 3000);
            } else {
                showMessage(result.message, 'error');
            }
        });

        // Message functions
        function showMessage(message, type) {
            const messageEl = document.getElementById('authMessage');
            messageEl.textContent = message;
            messageEl.className = `auth-message ${type}`;
            messageEl.classList.remove('hidden');
        }

        function clearMessage() {
            document.getElementById('authMessage').classList.add('hidden');
        }
    </script>
</body>

</html>