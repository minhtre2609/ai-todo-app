<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Trang c√° nh√¢n - AI Smart To-Do List">
    <title>Profile - AI Smart To-Do List</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-brand">
                <h2>ü§ñ AI Smart To-Do List</h2>
            </div>
            <div class="nav-menu">
                <span class="nav-user">üë§ <span id="navUserName">User</span></span>
                <a href="index.html" class="btn btn-secondary btn-sm">üìã Tasks</a>
                <a href="admin.html" id="adminLink" class="btn btn-secondary btn-sm hidden">‚öôÔ∏è Admin</a>
                <button id="logoutBtn" class="btn btn-secondary btn-sm">üö™ ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üë§ Th√¥ng Tin C√° Nh√¢n</h1>
            <p>Qu·∫£n l√Ω th√¥ng tin t√†i kho·∫£n v√† th·ªëng k√™ ho·∫°t ƒë·ªông</p>
        </header>

        <!-- Personal Information -->
        <section class="profile-section">
            <div class="glass-card">
                <h2>üì± Th√¥ng Tin C√° Nh√¢n</h2>
                <div class="profile-info">
                    <div class="profile-avatar">
                        <div class="avatar-circle" id="avatarCircle">üë§</div>
                    </div>

                    <div class="profile-details">
                        <div class="profile-info-row">
                            <span class="info-label">H·ªç v√† t√™n:</span>
                            <span class="info-value" id="profileFullName">-</span>
                        </div>

                        <div class="profile-info-row">
                            <span class="info-label">T√™n ƒëƒÉng nh·∫≠p:</span>
                            <span class="info-value" id="profileUsername">-</span>
                        </div>

                        <div class="profile-info-row">
                            <span class="info-label">Email:</span>
                            <span class="info-value" id="profileEmail">-</span>
                        </div>

                        <div class="profile-info-row">
                            <span class="info-label">Vai tr√≤:</span>
                            <span class="badge" id="profileRole">USER</span>
                        </div>

                        <div class="profile-info-row">
                            <span class="info-label">Ng√†y t·∫°o:</span>
                            <span class="info-value" id="profileCreatedAt">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Activity Statistics -->
        <section class="profile-section">
            <div class="glass-card">
                <h2>üìä Th·ªëng K√™ Ho·∫°t ƒê·ªông</h2>
                <div class="analysis-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statTotalTasks">0</div>
                        <div class="stat-label">T·ªïng C√¥ng Vi·ªác</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-value" id="statCompletedTasks">0</div>
                        <div class="stat-label">ƒê√£ Ho√†n Th√†nh</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-value" id="statPendingTasks">0</div>
                        <div class="stat-label">ƒêang L√†m</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-value" id="statCompletionRate">0%</div>
                        <div class="stat-label">T·ª∑ L·ªá Ho√†n Th√†nh</div>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="profileProgressFill" style="width: 0%"></div>
                </div>
            </div>
        </section>

        <!-- Edit Profile -->
        <section class="profile-section">
            <div class="glass-card">
                <h2>‚úèÔ∏è Ch·ªânh S·ª≠a Th√¥ng Tin</h2>
                <form id="editProfileForm" class="password-form">
                    <div class="input-wrapper">
                        <label for="editUsername">T√™n ƒëƒÉng nh·∫≠p m·ªõi</label>
                        <input type="text" id="editUsername" class="task-input"
                            placeholder="Nh·∫≠p username m·ªõi (3-20 k√Ω t·ª±, ch·ªØ/s·ªë/_)" pattern="[a-zA-Z0-9_]{3,20}">
                        <small style="color: var(--text-secondary);">ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi. ƒê·ªïi username s·∫Ω ƒë·ªïi c·∫£
                            email Firebase.</small>
                    </div>

                    <div class="input-wrapper">
                        <label for="editEmail">Email m·ªõi (t√πy ch·ªçn)</label>
                        <input type="email" id="editEmail" class="task-input" placeholder="Nh·∫≠p email m·ªõi">
                        <small style="color: var(--text-secondary);">ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi. Ch·ªâ ƒë·ªïi ƒë∆∞·ª£c n·∫øu kh√¥ng ƒë·ªïi
                            username.</small>
                    </div>

                    <div class="input-wrapper">
                        <label for="editPassword">M·∫≠t kh·∫©u x√°c nh·∫≠n *</label>
                        <input type="password" id="editPassword" class="task-input"
                            placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i ƒë·ªÉ x√°c nh·∫≠n" required>
                    </div>

                    <div id="editMessage" class="auth-message hidden"></div>

                    <button type="submit" class="btn btn-primary">
                        üíæ L∆∞u Thay ƒê·ªïi
                    </button>
                </form>
            </div>
        </section>

        <!-- Change Password -->
        <section class="profile-section">
            <div class="glass-card">
                <h2>üîê ƒê·ªïi M·∫≠t Kh·∫©u</h2>
                <form id="changePasswordForm" class="password-form">
                    <div class="input-wrapper">
                        <label for="oldPassword">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                        <input type="password" id="oldPassword" class="task-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i"
                            required>
                    </div>

                    <div class="input-wrapper">
                        <label for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
                        <input type="password" id="newPassword" class="task-input"
                            placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (t·ªëi thi·ªÉu 6 k√Ω t·ª±)" required minlength="6">
                    </div>

                    <div class="input-wrapper">
                        <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                        <input type="password" id="confirmPassword" class="task-input"
                            placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" required>
                    </div>

                    <div id="passwordMessage" class="auth-message hidden"></div>

                    <button type="submit" class="btn btn-primary">
                        üîí ƒê·ªïi M·∫≠t Kh·∫©u
                    </button>
                </form>
            </div>
        </section>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import authService from './firebase-auth.js';

        // Wait for auth and check login
        (async () => {
            await authService.waitForAuth();

            if (!authService.isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }

            const currentUser = authService.getCurrentUser();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Display user name in nav
            document.getElementById('navUserName').textContent = currentUser.fullName;

            // Show admin link if admin
            if (authService.isAdmin()) {
                document.getElementById('adminLink').classList.remove('hidden');
            }

            // Logout functionality
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await authService.logout();
                window.location.href = 'login.html';
            });

            // Load profile data
            await loadProfileData(currentUser);

            // Edit profile form
            document.getElementById('editProfileForm').addEventListener('submit', handleEditProfile);

            // Change password form
            document.getElementById('changePasswordForm').addEventListener('submit', handlePasswordChange);
        })();

        // Load profile data
        async function loadProfileData(user) {
            // Personal info
            document.getElementById('profileFullName').textContent = user.fullName;
            document.getElementById('profileUsername').textContent = '@' + user.username;
            document.getElementById('profileEmail').textContent = user.email;

            const roleBadge = document.getElementById('profileRole');
            roleBadge.textContent = user.role === 'admin' ? 'üëë ADMIN' : 'üë§ USER';
            roleBadge.className = user.role === 'admin' ? 'badge badge-priority critical' : 'badge badge-category';

            // Created date
            const createdDate = user.createdAt ? new Date(user.createdAt) : new Date();
            document.getElementById('profileCreatedAt').textContent = formatDate(createdDate);

            // Avatar initial
            const initial = user.fullName.charAt(0).toUpperCase();
            document.getElementById('avatarCircle').textContent = initial;

            // Load statistics
            const stats = await authService.getUserStats();
            document.getElementById('statTotalTasks').textContent = stats.totalTasks;
            document.getElementById('statCompletedTasks').textContent = stats.completedTasks;
            document.getElementById('statPendingTasks').textContent = stats.pendingTasks;
            document.getElementById('statCompletionRate').textContent = stats.completionRate + '%';
            document.getElementById('profileProgressFill').style.width = stats.completionRate + '%';
        }

        // Handle edit profile
        async function handleEditProfile(e) {
            e.preventDefault();

            const newUsername = document.getElementById('editUsername').value.trim();
            const newEmail = document.getElementById('editEmail').value.trim();
            const password = document.getElementById('editPassword').value;

            // Validate inputs
            if (!newUsername && !newEmail) {
                showEditMessage('Vui l√≤ng nh·∫≠p username ho·∫∑c email m·ªõi!', 'error');
                return;
            }

            if (newUsername && newEmail) {
                showEditMessage('Ch·ªâ c√≥ th·ªÉ ƒë·ªïi username HO·∫∂C email, kh√¥ng th·ªÉ ƒë·ªïi c·∫£ hai c√πng l√∫c!', 'error');
                return;
            }

            // Update username if provided
            if (newUsername) {
                const result = await authService.updateUsername(newUsername, password);
                if (!result.success) {
                    showEditMessage(result.message, 'error');
                    return;
                }

                showEditMessage(result.message, 'success');
                document.getElementById('editProfileForm').reset();

                setTimeout(() => {
                    authService.logout();
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            // Update email if provided
            if (newEmail) {
                const result = await authService.updateUserEmail(newEmail, password);
                if (!result.success) {
                    showEditMessage(result.message, 'error');
                    return;
                }

                showEditMessage(result.message, 'success');
                document.getElementById('editProfileForm').reset();

                setTimeout(() => {
                    authService.logout();
                    window.location.href = 'login.html';
                }, 2000);
            }
        }

        // Handle password change
        async function handlePasswordChange(e) {
            e.preventDefault();

            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validate
            if (newPassword !== confirmPassword) {
                showPasswordMessage('M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n kh√¥ng kh·ªõp!', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showPasswordMessage('M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!', 'error');
                return;
            }

            if (newPassword === oldPassword) {
                showPasswordMessage('M·∫≠t kh·∫©u m·ªõi kh√¥ng ƒë∆∞·ª£c tr√πng v·ªõi m·∫≠t kh·∫©u c≈©!', 'error');
                return;
            }

            // Change password
            const result = await authService.changePassword(oldPassword, newPassword);

            if (result.success) {
                showPasswordMessage(result.message, 'success');
                document.getElementById('changePasswordForm').reset();

                // Logout after 2 seconds
                setTimeout(async () => {
                    showPasswordMessage('ƒêang ƒëƒÉng xu·∫•t ƒë·ªÉ √°p d·ª•ng m·∫≠t kh·∫©u m·ªõi...', 'success');
                    setTimeout(async () => {
                        await authService.logout();
                        window.location.href = 'login.html';
                    }, 1000);
                }, 2000);
            } else {
                showPasswordMessage(result.message, 'error');
            }
        }

        // Show edit message
        function showEditMessage(message, type) {
            const messageEl = document.getElementById('editMessage');
            messageEl.textContent = message;
            messageEl.className = `auth-message ${type}`;
            messageEl.classList.remove('hidden');

            if (type === 'error') {
                setTimeout(() => {
                    messageEl.classList.add('hidden');
                }, 5000);
            }
        }

        // Show password message
        function showPasswordMessage(message, type) {
            const messageEl = document.getElementById('passwordMessage');
            messageEl.textContent = message;
            messageEl.className = `auth-message ${type}`;
            messageEl.classList.remove('hidden');

            if (type === 'error') {
                setTimeout(() => {
                    messageEl.classList.add('hidden');
                }, 5000);
            }
        }

        // Format date
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
    </script>
</body>

</html>