<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Trang c√° nh√¢n - AI Smart To-Do List">
    <title>Profile - AI Smart To-Do List</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-brand">
                <h2>ü§ñ AI Smart To-Do List</h2>
            </div>
            <div class="nav-menu">
                <span class="nav-user">üë§ <span id="navUserName">User</span></span>
                <a href="index.html" class="btn btn-secondary btn-sm">üìã Tasks</a>
                <a href="admin.html" id="adminLink" class="btn btn-secondary btn-sm hidden">‚öôÔ∏è Admin</a>
                <button id="logoutBtn" class="btn btn-secondary btn-sm">üö™ ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üë§ Th√¥ng Tin C√° Nh√¢n</h1>
            <p>Qu·∫£n l√Ω th√¥ng tin t√†i kho·∫£n v√† th·ªëng k√™ ho·∫°t ƒë·ªông</p>
        </header>

        <!-- Personal Information -->
        <section class="profile-section">
            <div class="glass-card">
                <h2>üì± Th√¥ng Tin C√° Nh√¢n</h2>
                <div class="profile-info">
                    <div class="profile-avatar">
                        <div class="avatar-circle" id="avatarCircle">üë§</div>
                    </div>

                    <div class="profile-details">
                        <div class="profile-info-row">
                            <span class="info-label">H·ªç v√† t√™n:</span>
                            <span class="info-value" id="profileFullName">-</span>
                        </div>

                        <div class="profile-info-row">
                            <span class="info-label">T√™n ƒëƒÉng nh·∫≠p:</span>
                            <span class="info-value" id="profileUsername">-</span>
                        </div>

                        <div class="profile-info-row">
                            <span class="info-label">Email:</span>
                            <span class="info-value" id="profileEmail">-</span>
                        </div>

                        <div class="profile-info-row">
                            <span class="info-label">Vai tr√≤:</span>
                            <span class="badge" id="profileRole">USER</span>
                        </div>

                        <div class="profile-info-row">
                            <span class="info-label">Ng√†y t·∫°o:</span>
                            <span class="info-value" id="profileCreatedAt">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Activity Statistics -->
        <section class="profile-section">
            <div class="glass-card">
                <h2>üìä Th·ªëng K√™ Ho·∫°t ƒê·ªông</h2>
                <div class="analysis-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statTotalTasks">0</div>
                        <div class="stat-label">T·ªïng C√¥ng Vi·ªác</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-value" id="statCompletedTasks">0</div>
                        <div class="stat-label">ƒê√£ Ho√†n Th√†nh</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-value" id="statPendingTasks">0</div>
                        <div class="stat-label">ƒêang L√†m</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-value" id="statCompletionRate">0%</div>
                        <div class="stat-label">T·ª∑ L·ªá Ho√†n Th√†nh</div>
                    </div>
                    <label for="oldPassword">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                    <input type="password" id="oldPassword" class="task-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i"
                        required>
                </div>

                <div class="input-wrapper">
                    <label for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="newPassword" class="task-input"
                        placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (t·ªëi thi·ªÉu 6 k√Ω t·ª±)" required minlength="6">
                </div>

                <div class="input-wrapper">
                    <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="confirmPassword" class="task-input" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi"
                        required>
                </div>

                <div id="passwordMessage" class="auth-message hidden"></div>

                <button type="submit" class="btn btn-primary">
                    üîí ƒê·ªïi M·∫≠t Kh·∫©u
                </button>
                </form>
            </div>
        </section>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import authService from './firebase-auth.js';

        // Wait for auth and check login
        (async () => {
            await authService.waitForAuth();

            if (!authService.isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }

            const currentUser = authService.getCurrentUser();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Display user name in nav
            document.getElementById('navUserName').textContent = currentUser.fullName;

            // Show admin link if admin
            if (authService.isAdmin()) {
                document.getElementById('adminLink').classList.remove('hidden');
            }

            // Logout functionality
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await authService.logout();
                window.location.href = 'login.html';
            });

            // Load profile data
            await loadProfileData(currentUser);

            // Change password form
            document.getElementById('changePasswordForm').addEventListener('submit', handlePasswordChange);
        })();

        // Load profile data
        async function loadProfileData(user) {
            // Personal info
            document.getElementById('profileFullName').textContent = user.fullName;
            document.getElementById('profileUsername').textContent = '@' + user.username;
            document.getElementById('profileEmail').textContent = user.email;

            const roleBadge = document.getElementById('profileRole');
            roleBadge.textContent = user.role === 'admin' ? 'üëë ADMIN' : 'üë§ USER';
            roleBadge.className = user.role === 'admin' ? 'badge badge-priority critical' : 'badge badge-category';

            // Created date
            const createdDate = user.createdAt ? new Date(user.createdAt) : new Date();
            document.getElementById('profileCreatedAt').textContent = formatDate(createdDate);

            // Avatar initial
            const initial = user.fullName.charAt(0).toUpperCase();
            document.getElementById('avatarCircle').textContent = initial;

            // Load statistics
            const stats = await authService.getUserStats();
            document.getElementById('statTotalTasks').textContent = stats.totalTasks;
            document.getElementById('statCompletedTasks').textContent = stats.completedTasks;
            document.getElementById('statPendingTasks').textContent = stats.pendingTasks;
            document.getElementById('statCompletionRate').textContent = stats.completionRate + '%';
            document.getElementById('profileProgressFill').style.width = stats.completionRate + '%';
        }

        // Handle password change
        async function handlePasswordChange(e) {
            e.preventDefault();

            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validate
            if (newPassword !== confirmPassword) {
                showPasswordMessage('M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n kh√¥ng kh·ªõp!', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showPasswordMessage('M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!', 'error');
                return;
            }

            if (newPassword === oldPassword) {
                showPasswordMessage('M·∫≠t kh·∫©u m·ªõi kh√¥ng ƒë∆∞·ª£c tr√πng v·ªõi m·∫≠t kh·∫©u c≈©!', 'error');
                return;
            }

            // Change password
            const result = await authService.changePassword(oldPassword, newPassword);

            if (result.success) {
                showPasswordMessage(result.message, 'success');
                document.getElementById('changePasswordForm').reset();

                // Logout after 2 seconds
                setTimeout(async () => {
                    showPasswordMessage('ƒêang ƒëƒÉng xu·∫•t ƒë·ªÉ √°p d·ª•ng m·∫≠t kh·∫©u m·ªõi...', 'success');
                    setTimeout(async () => {
                        await authService.logout();
                        window.location.href = 'login.html';
                    }, 1000);
                }, 2000);
            } else {
                showPasswordMessage(result.message, 'error');
            }
        }

        // Show password message
        function showPasswordMessage(message, type) {
            const messageEl = document.getElementById('passwordMessage');
            messageEl.textContent = message;
            messageEl.className = `auth-message ${type}`;
            messageEl.classList.remove('hidden');

            if (type === 'error') {
                setTimeout(() => {
                    messageEl.classList.add('hidden');
                }, 5000);
            }
        }

        // Format date
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
    </script>
</body>

</html>