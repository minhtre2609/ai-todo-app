<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Qu·∫£n l√Ω ng∆∞·ªùi d√πng - Admin Dashboard">
    <title>Admin Dashboard - AI Smart To-Do List</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-brand">
                <h2>ü§ñ AI Smart To-Do List</h2>
            </div>
            <div class="nav-menu">
                <span class="nav-user">üë§ <span id="navUserName">Admin</span></span>
                <a href="index.html" class="btn btn-secondary btn-sm">üìã Tasks</a>
                <a href="profile.html" class="btn btn-secondary btn-sm">üë§ Profile</a>
                <button id="logoutBtn" class="btn btn-secondary btn-sm">üö™ ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Admin Header -->
        <header class="header">
            <h1>‚öôÔ∏è Admin Dashboard</h1>
            <p>Qu·∫£n l√Ω ng∆∞·ªùi d√πng v√† theo d√µi ho·∫°t ƒë·ªông h·ªá th·ªëng</p>
        </header>

        <!-- Statistics Overview -->
        <section class="admin-stats-section">
            <div class="glass-card">
                <h2>üìä Th·ªëng K√™ T·ªïng Quan</h2>
                <div class="analysis-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">T·ªïng Ng∆∞·ªùi D√πng</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-value" id="totalSystemTasks">0</div>
                        <div class="stat-label">T·ªïng C√¥ng Vi·ªác</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-value" id="totalCompletedTasks">0</div>
                        <div class="stat-label">ƒê√£ Ho√†n Th√†nh</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-value" id="systemCompletionRate">0%</div>
                        <div class="stat-label">T·ª∑ L·ªá Ho√†n Th√†nh</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Users Management -->
        <section class="users-section">
            <div class="glass-card">
                <h2>üë• Qu·∫£n L√Ω Ng∆∞·ªùi D√πng</h2>
                <div id="usersContainer" class="users-container">
                    <!-- Users will be loaded here -->
                </div>
            </div>
        </section>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import authService from './firebase-auth.js';

        // Wait for auth and check admin
        (async () => {
            await authService.waitForAuth();

            if (!authService.isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }

            if (!authService.isAdmin()) {
                alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!');
                window.location.href = 'index.html';
                return;
            }

            // Display user name in nav
            const currentUser = authService.getCurrentUser();
            document.getElementById('navUserName').textContent = currentUser.fullName;

            // Logout functionality
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await authService.logout();
                window.location.href = 'login.html';
            });

            // Load users
            await loadUsers();
        })();

        // Load and display all users
        async function loadUsers() {
            const usersWithStats = await authService.getAllUsersWithStats();
            const usersContainer = document.getElementById('usersContainer');

            if (usersWithStats.length === 0) {
                usersContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üë§</div>
            <p>Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o trong h·ªá th·ªëng</p>
          </div>
        `;
                return;
            }

            usersContainer.innerHTML = usersWithStats.map(user => `
        <div class="user-card">
          <div class="user-header">
            <div class="user-icon">${user.role === 'admin' ? 'üëë' : 'üë§'}</div>
            <div class="user-info">
              <h3>${escapeHtml(user.fullName)}</h3>
              <p class="user-username">@${escapeHtml(user.username)}</p>
              <div class="user-meta">
                <span class="badge ${user.role === 'admin' ? 'badge-priority critical' : 'badge-category'}">
                  ${user.role === 'admin' ? 'üëë ADMIN' : 'üë§ USER'}
                </span>
                <span class="badge badge-time">
                  üìÖ ${formatDate(user.createdAt)}
                </span>
              </div>
            </div>
          </div>

          <div class="user-stats">
            <div class="user-stat">
              <div class="stat-label">C√¥ng vi·ªác</div>
              <div class="stat-value-sm">${user.stats.totalTasks}</div>
            </div>
            <div class="user-stat">
              <div class="stat-label">Ho√†n th√†nh</div>
              <div class="stat-value-sm">${user.stats.completedTasks}</div>
            </div>
            <div class="user-stat">
              <div class="stat-label">T·ª∑ l·ªá</div>
              <div class="stat-value-sm">${user.stats.completionRate}%</div>
            </div>
          </div>

          <div class="user-actions">
            ${user.username !== 'admin' ? `
              <button class="btn btn-secondary btn-sm" onclick="deleteUser('${escapeHtml(user.username)}')">
                üóëÔ∏è X√≥a ng∆∞·ªùi d√πng
              </button>
            ` : '<span class="text-muted">Kh√¥ng th·ªÉ x√≥a admin</span>'}
          </div>
        </div>
      `).join('');

            // Update overview statistics
            updateOverviewStats(usersWithStats);
        }

        // Update overview statistics
        function updateOverviewStats(usersWithStats) {
            const totalUsers = usersWithStats.length;
            let totalTasks = 0;
            let totalCompleted = 0;

            usersWithStats.forEach(user => {
                totalTasks += user.stats.totalTasks;
                totalCompleted += user.stats.completedTasks;
            });

            const completionRate = totalTasks > 0 ? Math.round((totalCompleted / totalTasks) * 100) : 0;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalSystemTasks').textContent = totalTasks;
            document.getElementById('totalCompletedTasks').textContent = totalCompleted;
            document.getElementById('systemCompletionRate').textContent = completionRate + '%';
        }

        // Delete user
        window.deleteUser = async function (username) {
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng "${username}"?\nD·ªØ li·ªáu c·ªßa ng∆∞·ªùi d√πng n√†y s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn!`)) {
                const result = await authService.deleteUser(username);

                if (result.success) {
                    alert(result.message);
                    await loadUsers(); // Reload users list
                } else {
                    alert(result.message);
                }
            }
        }

        // Helper: Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper: Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
    </script>
</body>

</html>